<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Ficha de {{ user_name }}</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body{font-family:'Open Sans',sans-serif;background:#0c0e2c;color:#e6e8ef;margin:0}
    header{padding:16px 28px;background:linear-gradient(90deg,#0c0e2c,#003559 55%,#00bfff)}
    h1{font-family:'Montserrat',sans-serif;margin:0;font-weight:700}
    .container{max-width:1100px;margin:0 auto;padding:28px 22px}
    .card{background:#fff;color:#222;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.2);padding:18px;margin-bottom:18px;border:1px solid #eef2f7}
    .title{margin:0 0 8px;font:700 18px 'Montserrat',sans-serif;color:#0c0e2c}
    .muted{color:#566}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef6ff;color:#1e3a8a;margin-left:8px;border:1px solid #dbeafe}
    .pill.good{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .pill.bad{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
    .section{margin-top:10px;padding:12px;border-radius:12px;border:1px solid #e4ecff;background:#f8fbff}
    .good{background:#ecfdf5;border-color:#a7f3d0}
    .bad{background:#fff7ed;border-color:#fed7aa}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .pill-m{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef6ff;color:#1e3a8a;margin:4px 6px 0 0;border:1px solid #dbeafe}
    .btn{display:inline-block;background:#00bfff;color:#000;font-weight:700;padding:10px 14px;border-radius:10px;text-decoration:none;border:none;cursor:pointer}
    .btn:hover{background:#00a4e6}
    textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e5e7eb}
    details summary{cursor:pointer}
    pre{background:#f4f7ff;border:1px solid #e3e9ff;border-radius:10px;padding:12px;white-space:pre-wrap}
    .label{font-weight:700;margin:8px 0 6px;display:block}
  </style>
  <script>
    function syncButtonText(checkbox, btnId){
      const btn = document.getElementById(btnId);
      btn.textContent = checkbox.checked ? "Enviar al usuario" : "Guardar (solo interno)";
    }
  </script>
</head>
<body>
<header><h1>üë§ {{ user_name }} <span class="pill">{{ email }}</span></h1></header>
<div class="container">
  {% if sessions|length == 0 %}
    <p class="muted">Sin sesiones todav√≠a.</p>
  {% endif %}

  {% for s in sessions %}
  <div class="card">
    <div class="title">{{ s.scenario or 'Sesi√≥n' }}</div>
    <div class="muted">
      Fecha: {{ s.timestamp or '‚Äî' }}
      {% if s.visible_to_user %}<span class="pill good">Enviado al usuario</span>{% else %}<span class="pill bad">Pendiente enviar</span>{% endif %}
    </div>

    {% if s.audio_path %}
      <p style="margin:10px 0">
        <a class="btn" href="/video/{{ s.audio_path|e }}" target="_blank">‚ñ∂ Ver video</a>
      </p>
    {% endif %}

    {# ====== MENSAJE DE CAPACITACI√ìN (solo lectura y lindo) ====== #}
    <div class="section">
      <strong>Mensaje de Capacitaci√≥n</strong>
      {% if s.training.is_json %}
        {% if s.training.summary %}<p style="margin-top:6px">{{ s.training.summary }}</p>{% endif %}
        <div class="grid-2">
          <div>
            <p><strong>Riesgo:</strong> {{ s.training.risk or 's/d' }}</p>
            <p><strong>Promedio KPI:</strong> {{ s.training.kpi_avg if s.training.kpi_avg is not none else 's/d' }}</p>
            <p><strong>Puntaje producto:</strong> {{ s.training.product_score_total if s.training.product_score_total is not none else 's/d' }}</p>
          </div>
          <div>
            <p><strong>Fases Da Vinci</strong>
              <span class="pill-m">Prep: {{ s.training.da_vinci.prep or '‚Äî' }}</span>
              <span class="pill-m">Apertura: {{ s.training.da_vinci.open or '‚Äî' }}</span>
              <span class="pill-m">Persuasi√≥n: {{ s.training.da_vinci.persuasion or '‚Äî' }}</span>
              <span class="pill-m">Cierre: {{ s.training.da_vinci.close or '‚Äî' }}</span>
            </p>
          </div>
        </div>
        {% if s.training.strengths and s.training.strengths|length>0 %}
          <div class="section good" style="margin-top:10px">
            <strong>Fortalezas</strong>
            <ul style="margin-top:6px">
              {% for it in s.training.strengths %}<li>{{ it }}</li>{% endfor %}
            </ul>
          </div>
        {% endif %}
        {% if s.training.opportunities and s.training.opportunities|length>0 %}
          <div class="section bad" style="margin-top:10px">
            <strong>Oportunidades</strong>
            <ul style="margin-top:6px">
              {% for it in s.training.opportunities %}<li>{{ it }}</li>{% endfor %}
            </ul>
          </div>
        {% endif %}
      {% else %}
        <p style="margin-top:6px">{{ s.evaluation_rh_raw or '‚Äî' }}</p>
      {% endif %}

      <details style="margin-top:8px">
        <summary>Editar an√°lisis (avanzado)</summary>
        <p class="muted">Si necesitas corregir el an√°lisis, ed√≠talo aqu√≠. Si no lo tocas, se mantiene igual.</p>
        <textarea name="evaluation_rh" form="f{{ s.id }}" rows="8">{{ s.evaluation_rh_raw }}</textarea>
      </details>
    </div>

    {# ====== RESUMEN P√öBLICO YA CALCULADO (si existe) ====== #}
    {% if s.evaluation %}
      <div class="section">
        <strong>Resumen para usuario (auto)</strong>
        <p>{{ s.evaluation }}</p>
      </div>
    {% endif %}

    {# ====== CONVERSACI√ìN (como en admin viejo, bloques limpios) ====== #}
    <div class="section">
      <strong>Conversaci√≥n</strong>
      <div class="grid-2" style="margin-top:8px">
        <div>
          <em>Usuario</em>
          <pre>{{ s.user_dialogue|join('\n') }}</pre>
        </div>
        <div>
          <em>Avatar</em>
          <pre>{{ s.avatar_dialogue|join('\n') }}</pre>
        </div>
      </div>
    </div>

    {# ====== FORMULARIO √öNICO: FEEDBACK + ENVIAR ====== #}
    <form id="f{{ s.id }}" method="post" action="/admin-user/{{ s.id }}/save" class="section" style="background:#f7fbff">
      <label class="label">Retroalimentaci√≥n (√∫nico bloque que ver√° el usuario)</label>
      <textarea name="feedback" rows="4" placeholder="Escribe aqu√≠ tu retro...">{% if s.visible_to_user %}{{ s.evaluation or s.evaluation_rh_raw or '' }}{% else %}{{ s.training.summary or '' }}{% endif %}</textarea>

      <p style="margin-top:10px">
        <label><input type="checkbox" name="send_to_user" onchange="syncButtonText(this,'btn{{ s.id }}')" {% if s.visible_to_user %}checked{% endif %}/> Enviar al usuario</label>
        <span class="muted">Si est√° marcado, la retro se publicar√° en el dashboard del participante.</span>
      </p>

      <button id="btn{{ s.id }}" class="btn" type="submit">{% if s.visible_to_user %}Enviar al usuario{% else %}Guardar (solo interno){% endif %}</button>
    </form>
  </div>
  {% endfor %}
</div>
<script>
  // Ajusta el texto del bot√≥n en el primer render seg√∫n el estado inicial
  document.querySelectorAll('input[name="send_to_user"]').forEach(cb => {
    const btn = document.getElementById('btn' + cb.form.id.replace('f',''));
    if (btn) { btn.textContent = cb.checked ? "Enviar al usuario" : "Guardar (solo interno)"; }
  });
</script>
</body>
</html>
