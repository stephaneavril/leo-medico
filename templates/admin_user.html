<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Ficha de {{ user_name }}</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0c0e2c; --card:#ffffff; --ink:#1f2937; --muted:#64748b;
      --line:#e5e7eb; --accent:#00bfff; --good:#065f46; --bad:#9a3412;
      --chip:#eef6ff; --chip-line:#dbeafe; --chip-ink:#1e3a8a;
      --good-bg:#ecfdf5; --good-line:#a7f3d0;
      --bad-bg:#fff7ed; --bad-line:#fed7aa;
    }
    body{font-family:'Open Sans',sans-serif;background:var(--bg);color:#e6e8ef;margin:0}
    header{padding:16px 28px;background:linear-gradient(90deg,#0c0e2c,#003559 55%,#00bfff)}
    h1{font-family:'Montserrat',sans-serif;margin:0;font-weight:700}
    .container{max-width:1100px;margin:0 auto;padding:28px 22px}
    .card{background:var(--card);color:var(--ink);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.2);padding:18px;margin-bottom:18px;border:1px solid var(--line)}
    .title{margin:0 0 6px;font:700 18px 'Montserrat',sans-serif;color:#0c0e2c}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--chip);color:var(--chip-ink);margin-left:8px;border:1px solid var(--chip-line)}
    .pill.good{background:var(--good-bg);color:var(--good);border-color:var(--good-line)}
    .pill.bad{background:var(--bad-bg);color:var(--bad);border-color:var(--bad-line)}
    .section{margin-top:10px;padding:12px;border-radius:12px;border:1px solid #e4ecff;background:#f8fbff}
    .good{background:var(--good-bg);border-color:var(--good-line)}
    .bad{background:var(--bad-bg);border-color:var(--bad-line)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .chip{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--chip);color:var(--chip-ink);margin:4px 6px 0 0;border:1px solid var(--chip-line)}
    .btn{display:inline-block;background:var(--accent);color:#000;font-weight:700;padding:10px 14px;border-radius:10px;text-decoration:none;border:none;cursor:pointer}
    .btn:hover{filter:brightness(.95)}
    textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);font-family:inherit}
    details summary{cursor:pointer}
    pre{background:#f4f7ff;border:1px solid #e3e9ff;border-radius:10px;padding:12px;white-space:pre-wrap;margin:0}
    .label{font-weight:700;margin:8px 0 6px;display:block}
    ul.conv{list-style:disc;padding-left:22px;margin:8px 0}
    ul.conv li{margin:6px 0}
    .tag{font-weight:700}
  </style>
  <script>
    function syncButtonText(checkbox, btnId){
      const btn = document.getElementById(btnId);
      btn.textContent = checkbox.checked ? "Enviar al usuario" : "Guardar (solo interno)";
    }
  </script>
</head>
<body>
<header><h1>👤 {{ user_name }} <span class="pill">{{ email }}</span></h1></header>

<div class="container">
  {% if sessions|length == 0 %}
    <div class="card"><p class="muted">Sin sesiones todavía.</p></div>
  {% endif %}

  {% for s in sessions %}
  <div class="card">
    <div class="title">{{ s.scenario or 'Sesión' }}</div>
    <div class="muted">
      Fecha: {{ s.timestamp or '—' }}
      {% if s.visible_to_user %}<span class="pill good">Enviado al usuario</span>{% else %}<span class="pill bad">Pendiente enviar</span>{% endif %}
    </div>

    {% if s.audio_path %}
      <p style="margin:10px 0">
        <a class="btn" href="/video/{{ s.audio_path|e }}" target="_blank">▶ Ver video</a>
      </p>
    {% endif %}

    <!-- ====== ANÁLISIS LEGIBLE (sin JSON crudo) ====== -->
    <div class="section" style="border:none;padding:0;background:transparent">

      {# Alias seguro para evitar fallos si 'readable' no existe #}
      {% set r = s.training.get('readable', {'score_14': None, 'listening': None, 'dv_signals': None, 'coaching': [], 'frase': '', 'rh_text': ''}) %}

      <!-- ===== BOX LEGIBLE (tipo tarjeta rosada) ===== -->
      <div style="
          background:#ffecec;
          border:1px solid #f9c2c2;
          border-left:6px solid #ef4444;
          color:#3b0d0d;
          border-radius:12px;
          padding:14px 16px;
          margin-bottom:12px;">
        <div style="font-weight:800;margin-bottom:6px;">Análisis para Capacitación:</div>
        <div style="margin-bottom:8px;">
          <strong>{{ user_name }}</strong>
          · Sesión: {{ s.timestamp or '—' }}
          {% if r.score_14 is not none %} · <strong>Score:</strong> {{ r.score_14 }}/14{% endif %}
          {% if s.training.risk %} · <strong>Riesgo:</strong> {{ s.training.risk }}{% endif %}
        </div>

        {% if s.training.strengths and s.training.strengths|length>0 %}
          <div><strong>Fortalezas:</strong> {{ s.training.strengths|join('; ') }}</div>
        {% endif %}

        {% if s.training.opportunities and s.training.opportunities|length>0 %}
          <div><strong>Oportunidades:</strong> {{ s.training.opportunities|join('; ') }}</div>
        {% endif %}

        {% if r.coaching and r.coaching|length>0 %}
          <div><strong>Coaching ({{ r.coaching|length }}):</strong> {{ r.coaching|join('; ') }}</div>
        {% endif %}

        {% if r.frase %}
          <div><strong>Frase guía:</strong> <em>{{ r.frase }}</em></div>
        {% endif %}

        {% if r.score_14 is not none or r.listening or r.dv_signals is not none %}
          <div><strong>KPI:</strong>
            {% if r.score_14 is not none %}Score 0–14: {{ r.score_14 }}{% endif %}
            {% if r.listening %}{{ ' · ' if r.score_14 is not none else '' }}Escucha activa: {{ r.listening }}{% endif %}
            {% if r.dv_signals is not none %}{{ ' · ' if r.score_14 is not none or r.listening else '' }}Fases Da Vinci: {{ r.dv_signals }} señales{% endif %}
          </div>
        {% endif %}
      </div>

      <!-- ===== Mensaje de Capacitación (sección descriptiva + JSON opcional) ===== -->
      <div class="section" style="margin-top:0">
        <strong>Mensaje de Capacitación</strong>

        {% if s.training.is_json %}
          {% if s.training.summary %}<p style="margin-top:6px">{{ s.training.summary }}</p>{% endif %}

          <div class="grid-2">
            <div>
              <p><strong>Riesgo:</strong> {{ s.training.risk or 's/d' }}</p>
              <p><strong>Promedio KPI:</strong> {{ s.training.kpi_avg if s.training.kpi_avg is not none else 's/d' }}</p>
              <p><strong>Puntaje de producto:</strong> {{ s.training.product_score_total if s.training.product_score_total is not none else 's/d' }}</p>
            </div>
            <div>
              <p><strong>Fases Da Vinci</strong>
                <span class="chip">Prep: {{ s.training.da_vinci.prep or '—' }}</span>
                <span class="chip">Apertura: {{ s.training.da_vinci.open or '—' }}</span>
                <span class="chip">Persuasión: {{ s.training.da_vinci.persuasion or '—' }}</span>
                <span class="chip">Cierre: {{ s.training.da_vinci.close or '—' }}</span>
              </p>
            </div>
          </div>

          {% if s.visual_feedback %}
            <div class="section" style="margin-top:10px">
              <strong>Imagen y postura</strong>
              <p style="margin-top:6px">{{ s.visual_feedback }}</p>
            </div>
          {% endif %}

          {% if s.training.strengths and s.training.strengths|length>0 %}
            <div class="section good" style="margin-top:10px">
              <strong>Fortalezas</strong>
              <ul style="margin-top:6px">
                {% for it in s.training.strengths %}<li>{{ it }}</li>{% endfor %}
              </ul>
            </div>
          {% endif %}
          {% if s.training.opportunities and s.training.opportunities|length>0 %}
            <div class="section bad" style="margin-top:10px">
              <strong>Oportunidades</strong>
              <ul style="margin-top:6px">
                {% for it in s.training.opportunities %}<li>{{ it }}</li>{% endfor %}
              </ul>
            </div>
          {% endif %}
        {% else %}
          <p style="margin-top:6px">{{ s.evaluation_rh_raw or '—' }}</p>
        {% endif %}

        <details style="margin-top:8px">
          <summary>Ver JSON (opcional)</summary>
          <p class="muted">Sólo si necesitas revisar el contenido crudo del análisis.</p>
          <pre>{{ s.evaluation_rh_raw }}</pre>
        </details>
      </div>
    </div>

    <!-- ====== RESUMEN PARA USUARIO (auto) si existe ====== -->
    {% if s.evaluation %}
      <div class="section">
        <strong>Resumen IA para el participante</strong>
        <p>{{ s.evaluation }}</p>
      </div>
    {% endif %}

    <!-- ====== CONVERSACIÓN: bullets alternando Usuario / Avatar ====== -->
    <div class="section">
      <strong>Conversación</strong>
      {% set ulen = s.user_dialogue|length %}
      {% set alen = s.avatar_dialogue|length %}
      {% set total = ulen if ulen>alen else alen %}
      <ul class="conv">
        {% for i in range(total) %}
          {% if i < ulen %}
            <li><span class="tag">👤 Usuario:</span> {{ s.user_dialogue[i] }}</li>
          {% endif %}
          {% if i < alen %}
            <li><span class="tag">🤖 Avatar:</span> {{ s.avatar_dialogue[i] }}</li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>

    <!-- ====== FORMULARIO: campo ÚNICO de retro + enviar ====== -->
    <form id="f{{ s.id }}" method="post" action="/admin-user/{{ s.id }}/save" class="section" style="background:#f7fbff">
      <label class="label">Retroalimentación para el participante</label>
      <textarea name="feedback" rows="5" placeholder="Escribe aquí la retro a enviar al participante…">{{ s.rh_comment or '' }}</textarea>

      <p style="margin-top:10px">
        <label><input type="checkbox" name="send_to_user" onchange="syncButtonText(this,'btn{{ s.id }}')" {% if s.visible_to_user %}checked{% endif %}/> Enviar al usuario</label>
        <span class="muted">Al marcar, la retro se publicará en el dashboard del participante.</span>
      </p>

      <details style="margin:6px 0 12px">
        <summary>Editar análisis (sólo si es necesario)</summary>
        <textarea name="evaluation_rh" rows="8">{{ s.evaluation_rh_raw }}</textarea>
      </details>

      <button id="btn{{ s.id }}" class="btn" type="submit">
        {% if s.visible_to_user %}Enviar al usuario{% else %}Guardar (solo interno){% endif %}
      </button>
    </form>
  </div>
  {% endfor %}
</div>

<script>
  // Ajusta el texto del botón en el primer render
  document.querySelectorAll('input[name="send_to_user"]').forEach(cb => {
    const id = cb.form.id.replace('f','');
    const btn = document.getElementById('btn'+id);
    if (btn) btn.textContent = cb.checked ? "Enviar al usuario" : "Guardar (solo interno)";
  });
</script>
</body>
</html>
