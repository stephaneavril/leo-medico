<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Ficha de {{ user_name }}</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
<style>
  body{font-family:'Open Sans',sans-serif;background:#0c0e2c;color:#e6e8ef;margin:0}
  header{padding:16px 28px;background:linear-gradient(90deg,#0c0e2c,#003559 55%,#00bfff)}
  h1{font-family:'Montserrat',sans-serif;margin:0;font-weight:700}
  .container{max-width:1100px;margin:0 auto;padding:28px 22px}
  .card{background:#fff;color:#222;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.2);padding:18px;margin-bottom:18px;border:1px solid #eef2f7}
  .title{margin:0 0 8px;font:700 18px 'Montserrat',sans-serif;color:#0c0e2c}
  .muted{color:#566}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef6ff;color:#1e3a8a;margin:4px 6px 0 0;border:1px solid #dbeafe}
  .section{margin-top:10px;padding:12px;border-radius:12px;border:1px solid #e4ecff;background:#f8fbff}
  .bad{background:#fff7ed;border-color:#fed7aa}
  .good{background:#ecfdf5;border-color:#a7f3d0}
  .btn{display:inline-block;background:#00bfff;color:#000;font-weight:700;padding:8px 12px;border-radius:10px;text-decoration:none}
  .btn:hover{background:#00a4e6}
  textarea,input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid #e5e7eb}
  label{font-weight:700}
</style>
</head>
<body>
<header><h1>üë§ {{ user_name }} <span class="pill">{{ email }}</span></h1></header>
<div class="container">
  {% if sessions|length == 0 %}
    <p class="muted">Sin sesiones todav√≠a.</p>
  {% endif %}

  {% for s in sessions %}
  <div class="card">
    <div class="title">{{ s.scenario or 'Sesi√≥n' }}</div>
    <div class="muted">Fecha: {{ s.timestamp or '‚Äî' }} {% if s.visible_to_user %}<span class="pill good">Enviado al usuario</span>{% else %}<span class="pill bad">Pendiente enviar</span>{% endif %}</div>

    {% if s.audio_path %}
      <p style="margin:10px 0">
        <a class="btn" href="/video/{{ s.audio_path|e }}" target="_blank">‚ñ∂ Ver video</a>
      </p>
    {% endif %}

    {# ====== BLOQUE: MENSAJE DE CAPACITACI√ìN (limpio) ====== #}
    <div class="section">
      <strong>Mensaje de Capacitaci√≥n</strong>
      {% if s.training.is_json %}
        {% if s.training.summary %}<p>{{ s.training.summary }}</p>{% endif %}
        <div class="grid">
          <div>
            <p><strong>Riesgo:</strong> {{ s.training.risk or 's/d' }}</p>
            <p><strong>Promedio KPI:</strong> {{ s.training.kpi_avg if s.training.kpi_avg is not none else 's/d' }}</p>
            <p><strong>Puntaje producto:</strong> {{ s.training.product_score_total if s.training.product_score_total is not none else 's/d' }}</p>
          </div>
          <div>
            <p><strong>Fases Da Vinci</strong>
              <span class="pill">Prep: {{ s.training.da_vinci.prep or '‚Äî' }}</span>
              <span class="pill">Apertura: {{ s.training.da_vinci.open or '‚Äî' }}</span>
              <span class="pill">Persuasi√≥n: {{ s.training.da_vinci.persuasion or '‚Äî' }}</span>
              <span class="pill">Cierre: {{ s.training.da_vinci.close or '‚Äî' }}</span>
            </p>
          </div>
        </div>
        {% if s.training.strengths and s.training.strengths|length>0 %}
          <div class="section good">
            <strong>Fortalezas</strong>
            <ul style="margin-top:6px">
              {% for it in s.training.strengths %}<li>{{ it }}</li>{% endfor %}
            </ul>
          </div>
        {% endif %}
        {% if s.training.opportunities and s.training.opportunities|length>0 %}
          <div class="section bad">
            <strong>Oportunidades</strong>
            <ul style="margin-top:6px">
              {% for it in s.training.opportunities %}<li>{{ it }}</li>{% endfor %}
            </ul>
          </div>
        {% endif %}
        <details style="margin-top:8px"><summary>Ver JSON completo</summary><pre style="white-space:pre-wrap">{{ s.evaluation_rh_raw }}</pre></details>
      {% else %}
        <p>{{ s.evaluation_rh_raw or '‚Äî' }}</p>
      {% endif %}
    </div>

    {# ====== BLOQUE: RESUMEN PARA USUARIO (lo que ve el usuario) ====== #}
    {% if s.evaluation %}
      <div class="section">
        <strong>Resumen para usuario (visible en dashboard)</strong>
        <p>{{ s.evaluation }}</p>
      </div>
    {% endif %}

    {# ====== BLOQUE: CHAT LIMPIO ====== #}
    <div class="section">
      <strong>Conversaci√≥n</strong>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
        <div>
          <em>Usuario</em>
          <ul>{% for line in s.user_dialogue %}<li>{{ line }}</li>{% endfor %}</ul>
        </div>
        <div>
          <em>Avatar</em>
          <ul>{% for line in s.avatar_dialogue %}<li>{{ line }}</li>{% endfor %}</ul>
        </div>
      </div>
    </div>

    {# ====== BLOQUE: FORM RETRO (admin escribe/revisa/env√≠a) ====== #}
    <form method="post" action="/admin-user/{{ s.id }}/save" class="section" style="background:#f7fbff">
      <strong>Revisi√≥n y retroalimentaci√≥n</strong>
      <p class="muted" style="margin-top:6px">Edita y guarda. Marca ‚ÄúEnviar al usuario‚Äù para publicarlo en su dashboard.</p>

      <label>Mensaje de Capacitaci√≥n (JSON o texto)</label>
      <textarea name="evaluation_rh" rows="6">{{ s.evaluation_rh_raw }}</textarea>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>Tip</label>
          <input type="text" name="tip" value="{{ s.tip }}" />
        </div>
        <div>
          <label>Feedback visual</label>
          <input type="text" name="visual_feedback" value="{{ s.visual_feedback }}" />
        </div>
      </div>

      <p style="margin-top:10px">
        <label><input type="checkbox" name="send_to_user" {% if s.visible_to_user %}checked{% endif %}/> Enviar al usuario</label>
      </p>

      <button class="btn" type="submit">üíæ Guardar</button>
    </form>
  </div>
  {% endfor %}
</div>
</body>
</html>
